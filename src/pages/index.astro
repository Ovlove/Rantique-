---
import Layout from '../layouts/BaseLayout.astro';
import Alert from '../components/Alert.astro';
import { getCollection } from 'astro:content';

function calculateReadingTime(text) {
  const wordsPerMinute = 200;
  const wordCount = text.trim().split(/\s+/).length;
  return Math.ceil(wordCount / wordsPerMinute);
}

// Fetch latest 10 blog posts
const rawBlogPosts = await getCollection('blog');
const blogPosts = rawBlogPosts
  .sort((a, b) => b.data.pubDate - a.data.pubDate)
  .slice(0, 10)
  .map(post => ({
    slug: post.slug,
    title: post.data.title,
    description: post.data.description || '',
    pubDate: post.data.pubDate,
    formattedDate: post.data.pubDate.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    }),
    readingTime: calculateReadingTime(post.body?.raw || ''),
  }));

// Fetch latest 10 fiction posts
const rawFictionPosts = await getCollection('fiction');
const fictionPosts = rawFictionPosts
  .sort((a, b) => b.data.pubDate - a.data.pubDate)
  .slice(0, 10)
  .map(post => ({
    slug: post.slug,
    title: post.data.title,
    description: post.data.description || '',
    pubDate: post.data.pubDate,
    formattedDate: post.data.pubDate.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    }),
    readingTime: calculateReadingTime(post.body?.raw || ''),
  }));
---

<style>
  /* Hide scrollbar but keep scrollable - cross browser */
  .hide-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .hide-scrollbar {
    -ms-overflow-style: none; /* IE and Edge */
    scrollbar-width: none; /* Firefox */
  }
</style>

<Layout title="Rantique â€“ A Boutique of Insightful Ideas" description="Articles, opinions, and short fiction that spark thought.">
  <main class="max-w-6xl mx-auto px-6 py-16 space-y-20">

    <!-- Hero Section -->
    <section class="text-center">
      <img src="/favicon-32x32.png" alt="Rantique Logo" class="mx-auto w-14 h-14 mb-6" loading="lazy" />
      <h1 class="text-5xl font-extrabold tracking-tight text-gray-900 dark:text-white">
        Welcome to <span class="text-purple-600 dark:text-purple-400">Rantique</span>
      </h1>
      <p class="mt-4 text-lg text-gray-600 dark:text-gray-300 max-w-xl mx-auto">
        A boutique of insightful ideas â€” exploring stories, commentary, and conversations that matter.
      </p>
      <Alert type="success" class="mt-6 max-w-md mx-auto">
        ðŸŽ‰ Rantique is live â€” thanks for being here early!
      </Alert>
    </section>

    <!-- Blog Search Input -->
    <section class="max-w-md mx-auto">
      <input
        type="search"
        placeholder="Search blog posts..."
        class="w-full px-5 py-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 dark:bg-gray-800 dark:text-white"
        x-data=""
        x-model.debounce.300ms="query"
        aria-label="Search blog posts"
      />
    </section>

    <!-- Blog Posts Carousel -->
    <section aria-label="Latest Blog Posts">
      <h2 class="text-3xl font-semibold text-gray-900 dark:text-white mb-6">Latest Blog Posts</h2>
      <div
        class="flex overflow-x-auto hide-scrollbar space-x-6 snap-x snap-mandatory"
        x-data="postsData()"
        x-init="initPosts(rawJsonBlog.textContent)"
      >
        <template x-for="post in filteredPosts()" :key="post.slug">
          <article
            class="flex-shrink-0 w-72 bg-white dark:bg-[#1A1A2E] rounded-lg p-6 shadow-md snap-start"
          >
            <a
              :href="`/blog/${post.slug}/`"
              class="text-xl font-semibold text-purple-700 dark:text-purple-400 hover:underline block"
              x-html="highlight(post.title)"
            ></a>
            <p
              class="mt-2 text-gray-700 dark:text-gray-300 text-sm"
              x-show="post.description"
              x-html="highlight(post.description)"
            ></p>
            <p class="mt-4 text-xs text-gray-500 dark:text-gray-400">
              <span x-text="post.formattedDate"></span> Â· <span x-text="post.readingTime + ' min read'"></span>
            </p>
          </article>
        </template>
      </div>
      <p
        x-show="filteredPosts().length === 0"
        class="text-center text-gray-500 italic mt-4"
      >
        No blog posts found.
      </p>
    </section>

    <!-- Fiction Posts Carousel -->
    <section aria-label="Latest Fiction Stories">
      <h2 class="text-3xl font-semibold text-gray-900 dark:text-white mb-6">Latest Fiction Stories</h2>
      <div
        class="flex overflow-x-auto hide-scrollbar space-x-6 snap-x snap-mandatory"
      >
        {fictionPosts.length > 0 ? (
          <>
            {fictionPosts.map(post => (
              <article
                key={post.slug}
                class="flex-shrink-0 w-72 bg-white dark:bg-[#1A1A2E] rounded-lg p-6 shadow-md snap-start"
              >
                <a
                  href={`/fiction/${post.slug}/`}
                  class="text-xl font-semibold text-purple-700 dark:text-purple-400 hover:underline block"
                >
                  {post.title}
                </a>
                <p class="mt-2 text-gray-700 dark:text-gray-300 text-sm">{post.description}</p>
                <p class="mt-4 text-xs text-gray-500 dark:text-gray-400">
                  {post.formattedDate} Â· {post.readingTime} min read
                </p>
              </article>
            ))}
          </>
        ) : (
          <p class="text-center text-gray-500 italic mt-4">No fiction stories found.</p>
        )}
      </div>
    </section>

    <!-- Alpine.js Raw JSON for Blog Posts -->
    <script type="application/json" x-ref="rawJsonBlog" class="hidden">
      {JSON.stringify(blogPosts)}
    </script>

    <script>
      function postsData() {
        return {
          query: '',
          posts: [],
          initPosts(json) {
            this.posts = JSON.parse(json);
          },
          filteredPosts() {
            const q = this.query.toLowerCase().trim();
            if (!q) return this.posts;
            return this.posts.filter(
              p =>
                p.title.toLowerCase().includes(q) ||
                p.description.toLowerCase().includes(q)
            );
          },
          highlight(text) {
            if (!this.query) return this.escapeHtml(text);
            const q = this.query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
            const regex = new RegExp(`(${q})`, 'gi');
            return this.escapeHtml(text).replace(regex, '<mark class="bg-yellow-200 dark:bg-yellow-600">$1</mark>');
          },
          escapeHtml(text) {
            return text
              .replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#039;');
          },
        };
      }
    </script>
  </main>
</Layout>
