---
import Layout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// Fetch blog posts
const posts = await getCollection('blog');

// Prepare Alpine-friendly version
const wordsPerMinute = 200;
const alpinePosts = posts.map(post => {
  const rawText = post.body?.raw || '';
  const wordCount = rawText.trim().split(/\s+/).length;
  const readingTime = Math.max(1, Math.ceil(wordCount / wordsPerMinute));
  
  return {
    slug: post.slug,
    title: post.data.title,
    description: post.data.description || '',
    pubDate: post.data.pubDate instanceof Date ? post.data.pubDate.toISOString() : '',
    readingTime,
  };
});
---

<Layout title="Rantique Blog" description="Latest articles, insights, and curated thoughts.">
  <main class="px-4 md:px-8 lg:px-16 py-12 space-y-10" x-data="{ query: '', posts: [] }" x-init="posts = JSON.parse($refs.postsData.textContent)">
    
    <!-- Header -->
    <section class="text-center">
      <h1 class="text-4xl sm:text-5xl font-bold tracking-tight text-[#1A1A2E] dark:text-white">Rantique Blog</h1>
      <p class="mt-2 text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
        Explore reflections, commentary, and original thoughts curated for curious minds.
      </p>
    </section>

    <!-- Search -->
    <div class="max-w-xl mx-auto">
      <input 
        type="search"
        placeholder="Search posts..."
        class="w-full px-4 py-2 mt-6 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
        x-model="query"
        aria-label="Search blog posts"
      />
    </div>

    <!-- Post List -->
    <ul class="space-y-6 max-w-3xl mx-auto">
      <template x-for="post in posts.filter(p => {
        const q = query.toLowerCase();
        return p.title.toLowerCase().includes(q) || p.description.toLowerCase().includes(q);
      })" :key="post.slug">
        <li class="border-b border-gray-200 dark:border-gray-700 pb-4">
          <a :href="`/blog/${post.slug}/`" class="text-xl font-semibold text-purple-600 dark:text-purple-400 hover:underline" x-text="post.title"></a>
          <p class="text-gray-500 text-sm" x-text="post.description" x-show="post.description"></p>
          <p class="text-gray-400 text-xs">
            <span x-text="new Date(post.pubDate).toDateString()"></span> &middot; 
            <span x-text="`${post.readingTime} min read`"></span>
          </p>
        </li>
      </template>

      <p x-show="posts.filter(p => p.title.toLowerCase().includes(query.toLowerCase()) || p.description.toLowerCase().includes(query.toLowerCase())).length === 0"
         class="text-center text-gray-500 italic mt-8">
        No posts found.
      </p>
    </ul>

    <!-- Alpine.js Data Source -->
    <script type="application/json" x-ref="postsData" class="hidden">
      {JSON.stringify(alpinePosts)}
    </script>

    <!-- Optional: Pagination Placeholder -->
    <!-- <nav class="text-center pt-8">
      <a href="/blog/page/2" class="text-purple-600 hover:underline">Next Page â†’</a>
    </nav> -->
  </main>
</Layout>
